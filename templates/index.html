{% extends "layout.html" %}

{% block content %}
<div class="row justify-content-center mb-4">
	<div class="col-lg-8">
		<!-- User Location Card (from backend) -->
		{% if user_location and not user_location.error %}
		<div class="card shadow-sm mb-4">
			<div class="card-header bg-success text-white">
				<h5 class="mb-0">Your Approximate Location</h5>
			</div>
			<div class="card-body">
				<h6 class="card-title mb-2">{{ user_location.city }}, {{ user_location.country }}</h6>
				{% if user_location.weather and user_location.weather.current_weather %}
				<ul class="list-group list-group-flush mb-2">
					<li class="list-group-item">Temperature: <strong>{{ user_location.weather.current_weather.temperature }} °C</strong></li>
					<li class="list-group-item">Windspeed: <strong>{{ user_location.weather.current_weather.windspeed }} km/h</strong></li>
					<li class="list-group-item">Weather Code: <strong>{{ user_location.weather.current_weather.weathercode }}</strong></li>
				</ul>
				{% else %}
				<div class="alert alert-warning mb-0">Weather data is not available for your location.</div>
				{% endif %}
			</div>
		</div>
		{% elif user_location and user_location.error %}
		<div class="alert alert-danger mb-4">{{ user_location.error }}</div>
		{% endif %}
		<!-- Main Weather Card -->
		<div class="card shadow-sm mb-4">
			<div class="card-header bg-primary text-white">
				<h1 class="mb-0">Weather for 10 Major Cities</h1>
			</div>
			<div class="card-body">
				<form id="reportForm" class="row g-3 align-items-end" onsubmit="return false;">
					<div class="col-md-5">
						<label for="city" class="form-label">City</label>
						<select id="city" class="form-select">
							{% for c in cities %}
							<option value="{{c}}">{{c}}</option>
							{% endfor %}
						</select>
					</div>
					<div class="col-md-5">
						<label for="style" class="form-label">Style</label>
						<select id="style" class="form-select">
							{% for s in styles %}
							<option value="{{s}}">{{s}}</option>
							{% endfor %}
						</select>
					</div>
					<div class="col-md-2 d-grid">
						<button class="btn btn-primary" onclick="generateReport()">Generate Weather Report</button>
					</div>
				</form>
				<div class="alert alert-info mt-4" id="reportBox">Select a city and style, then click Generate Weather Report.</div>
				<table class="table table-striped table-hover mt-3" id="weatherTable" style="display:none;">
					<thead>
						<tr>
							<th>Temperature (°C)</th>
							<th>Windspeed (km/h)</th>
							<th>Weather Code</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td id="tempCell"></td>
							<td id="windCell"></td>
							<td id="codeCell"></td>
						</tr>
					</tbody>
				</table>
				<div class="mt-4">
					<h5>City Pages</h5>
					<ul class="list-inline">
						{% for c in cities %}
						<li class="list-inline-item mb-2">
							<a class="btn btn-outline-secondary btn-sm" href="/{{c}}">View {{c}} Forecast</a>
						</li>
						{% endfor %}
					</ul>
				</div>
			</div>
		</div>
	</div>
</div>
<script>
	function generateReport() {
		const cityName = document.getElementById('city').value;
		const style = document.getElementById('style').value;
		fetch('/generate_report', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({ city: cityName, style: style })
		})
		.then(res => res.json())
		.then(data => {
			document.getElementById('reportBox').innerText = data.report;
			// Show weather table
			if (data.weather) {
				document.getElementById('weatherTable').style.display = '';
				document.getElementById('tempCell').innerText = data.weather.temperature ?? 'N/A';
				document.getElementById('windCell').innerText = data.weather.windspeed ?? 'N/A';
				document.getElementById('codeCell').innerText = data.weather.weathercode ?? 'N/A';
			}
		});
	}
</script>
{% endblock %}