{% extends "layout.html" %}

{% block content %}
<div class="row justify-content-center mb-4">
	<div class="col-lg-8">
		<!-- User Location Card (from backend) -->
		{% if user_location and not user_location.error %}
		<div class="card shadow-sm mb-4">
			<div class="card-header bg-success text-white">
				<h5 class="mb-0">Current weather in {{ user_location.city }}, {{ user_location.country }}</h5>
			</div>
			<div class="card-body">
				{% if user_location.weather and user_location.weather.current %}
                <div class="row">
                    <div class="col-5 justify-content-between">
                        <h1 class="display-1">{{ user_location.weather.current.temperature_2m }} °C</h1>
                    </div>
                    <div class="col-7">                    
                        <ul class="list-group list-group-flush mb-2">
                            <li class="list-group-item">Wind: <strong> {{ user_location.weather.current.cardinal }} {{ user_location.weather.current.wind_speed_10m }} km/h</strong></li>
                            <li class="list-group-item">Pressure: <strong>{{ user_location.weather.current.pressure_msl }} hPa</strong></li>
                            <li class="list-group-item">Humidity: <strong>{{ user_location.weather.current.relative_humidity_2m }}%</strong></li>
                        </ul>
                    </div>
                </div>
				{% else %}
				<div class="alert alert-warning mb-0">Weather data is not available for your location.</div>
				{% endif %}


                {% if user_hourly_forecast %}
                <hr>
                <div class="swiper hourly-forecast-swiper">
                    <div class="swiper-wrapper">
                        {% for hour in user_hourly_forecast %}
                            <div class="swiper-slide">
                                {% if loop.index0 == 0 %}
                                    now<br>
                                {% else %}
                                    {{ hour.time }}<br>
                                {% endif %}

                                <strong class="text-danger">{{ hour.temperature|round|int }} °C</strong><br>
                                <i class="wi wi-day-sunny"></i><br>
                                <i title="{{ hour.cardinal|lower }}" class="wi wi-wind from-{{ hour.winddirection }}-deg"></i><br>
                                <i title="{{ hour.beaufort }} on Beaufort Scale, {{ hour.windspeed }} km/h" class="wi wi-wind-beaufort-{{ hour.beaufort }}"></i>
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        var swiper = new Swiper(".hourly-forecast-swiper", {
                            slidesPerView: 4,
                            spaceBetween: 10,
                            breakpoints: {
                                640: {
                                    slidesPerView: 4,
                                    spaceBetween: 20,
                                },
                                768: {
                                    slidesPerView: 6,
                                    spaceBetween: 20,
                                },
                                1024: {
                                    slidesPerView: 8,
                                    spaceBetween: 20,
                                },
                            },
                        });
                    });                    
                </script>
				{% endif %}
			</div>
		</div>
		{% elif user_location and user_location.error %}
		<div class="alert alert-danger mb-4">{{ user_location.error }}</div>
		{% endif %}
		<!-- Main Weather Card -->
		<div class="card shadow-sm mb-4">
			<div class="card-header bg-primary text-white">
				<h1 class="mb-0">Weather for 10 Major Cities</h1>
			</div>
			<div class="card-body">
				<form id="reportForm" class="row g-3 align-items-end" onsubmit="return false;">
					<div class="col-md-5">
						<label for="city" class="form-label">City</label>
						<select id="city" class="form-select">
							{% for c in cities %}
							<option value="{{c}}">{{c}}</option>
							{% endfor %}
						</select>
					</div>
					<div class="col-md-5">
						<label for="style" class="form-label">Style</label>
						<select id="style" class="form-select">
							{% for s in styles %}
							<option value="{{s}}">{{s}}</option>
							{% endfor %}
						</select>
					</div>
					<div class="col-md-2 d-grid">
						<button class="btn btn-primary" onclick="generateReport()">Generate Weather Report</button>
					</div>
				</form>
				<div class="alert alert-info mt-4" id="reportBox">Select a city and style, then click Generate Weather Report.</div>
				<table class="table table-striped table-hover mt-3" id="weatherTable" style="display:none;">
					<thead>
						<tr>
							<th>Temperature (°C)</th>
							<th>Windspeed (km/h)</th>
							<th>Weather Code</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td id="tempCell"></td>
							<td id="windCell"></td>
							<td id="codeCell"></td>
						</tr>
					</tbody>
				</table>
				<div class="mt-4">
					<h5>City Pages</h5>
					<ul class="list-inline">
						{% for c in cities %}
						<li class="list-inline-item mb-2">
							<a class="btn btn-outline-secondary btn-sm" href="/{{c}}">View {{c}} Forecast</a>
						</li>
						{% endfor %}
					</ul>
				</div>
			</div>
		</div>
	</div>
</div>
<script>
	function generateReport() {
		const cityName = document.getElementById('city').value;
		const style = document.getElementById('style').value;
		fetch('/generate_report', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({ city: cityName, style: style })
		})
		.then(res => res.json())
		.then(data => {
			document.getElementById('reportBox').innerText = data.report;
			// Show weather table
			if (data.weather) {
				document.getElementById('weatherTable').style.display = '';
				document.getElementById('tempCell').innerText = data.weather.temperature ?? 'N/A';
				document.getElementById('windCell').innerText = data.weather.windspeed ?? 'N/A';
				document.getElementById('codeCell').innerText = data.weather.weathercode ?? 'N/A';
			}
		});
	}
</script>
{% endblock %}